<!-- Keenetic Dashboard v1.1.3 -->

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Keenetic Home Monitor</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üè†</text></svg>">
    <style>
        :root { 
            --bg: #f4f7f6; --card: #ffffff; --text: #333; --muted: #6c757d; 
            --border: #e9ecef; 
            --blue: #0d6efd; --green: #198754; --red: #dc3545; --orange: #fd7e14; --purple: #6f42c1;
            --shadow: rgba(0,0,0,0.05); --hover: #f8f9fa;
            --term-bg: #1e1e1e; --term-text: #00ff00; --term-filter: #aaaaaa;
        }
        @media (prefers-color-scheme: dark) { 
            :root { --bg: #121212; --card: #1e1e1e; --text: #e0e0e0; --muted: #a0a0a0; --border: #2c2c2c; --shadow: rgba(0,0,0,0.5); --hover: #2a2a2a; } 
        }

        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: var(--bg); color: var(--text); padding: 20px; max-width: 1200px; margin: 0 auto; display: flex; flex-direction: column; min-height: 95vh; }
        
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; padding: 0 5px; flex-wrap: wrap; gap: 15px; }
        .header h1 { font-size: 1.6rem; margin: 0; font-weight: 800; letter-spacing: -0.5px; }
        .header-controls { display: flex; align-items: center; gap: 10px; }
        .clock-badge { font-size: 0.85rem; color: var(--muted); background: var(--card); padding: 6px 12px; border-radius: 20px; border: 1px solid var(--border); font-weight: 600; min-width: 80px; text-align: center; }
        .refresh-select { background: var(--card); color: var(--text); border: 1px solid var(--border); padding: 6px 10px; border-radius: 20px; font-size: 0.8rem; font-weight: 600; cursor: pointer; outline: none; transition: border-color 0.2s; }
        .refresh-select:hover { border-color: var(--blue); }

        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; align-items: stretch; margin-bottom: 30px; }
        .card { background: var(--card); border-radius: 12px; padding: 20px; box-shadow: 0 4px 15px var(--shadow); border: 1px solid var(--border); transition: transform 0.2s, box-shadow 0.2s, border-color 0.2s; cursor: pointer; display: flex; flex-direction: column; height: 100%; box-sizing: border-box; }
        .card:hover { transform: translateY(-3px); box-shadow: 0 8px 25px var(--shadow); border-color: var(--blue); }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid var(--border); }
        .card-header h3 { margin: 0; font-size: 1rem; font-weight: 700; display: flex; align-items: center; gap: 10px; text-transform: uppercase; letter-spacing: 0.5px; }
        .card-header h3::before { content: ''; display: block; width: 4px; height: 16px; border-radius: 2px; flex-shrink: 0; }
        .card-fw h3::before { background: var(--red); }
        .card-tr h3::before { background: var(--blue); }
        .card-ping h3::before { background: var(--green); }
        .status-dot { height: 8px; width: 8px; border-radius: 50%; background-color: var(--muted); display: inline-block; box-shadow: 0 0 5px currentColor; opacity: 0.5; }
        .status-dot.online { background-color: var(--green); color: var(--green); opacity: 1; }
        .status-dot.offline { background-color: var(--red); color: var(--red); opacity: 1; }
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; flex-grow: 1; margin-bottom: 15px; }
        .stat-item { background: var(--hover); padding: 10px 12px; border-radius: 8px; display: flex; flex-direction: column; justify-content: center; min-width: 0; }
        .stat-label { font-size: 0.7rem; text-transform: uppercase; color: var(--muted); margin-bottom: 4px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .stat-value { font-size: 1.1rem; font-weight: 800; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; line-height: 1.2; }
        .sub-text { font-size: 0.75rem; color: var(--muted); margin-top: auto; font-weight: 400; text-align: right; opacity: 0.8; }
        .txt-red { color: var(--red); } .txt-blue { color: var(--blue); } .txt-green { color: var(--green); } .txt-orange { color: var(--orange); } .txt-purple { color: var(--purple); }
        
        /* LOG VIEWER STYLES */
        .log-container details {
            background: var(--card); border: 1px solid var(--border); border-radius: 12px;
            box-shadow: 0 4px 15px var(--shadow); overflow: hidden;
            transition: all 0.3s ease; margin-bottom: 15px;
        }
        .log-container summary {
            padding: 15px 20px; font-weight: 700; cursor: pointer; list-style: none;
            display: flex; justify-content: space-between; align-items: center;
            background: var(--card); color: var(--text);
        }
        .log-container summary::-webkit-details-marker { display: none; }
        .log-container summary:hover { background: var(--hover); }
        .log-title { display: flex; align-items: center; gap: 10px; font-size: 1rem; text-transform: uppercase; }
        .log-controls { display: flex; gap: 10px; }
        .btn-log {
            padding: 5px 12px; font-size: 0.75rem; border-radius: 4px; border: 1px solid var(--border);
            background: var(--bg); color: var(--text); cursor: pointer; font-weight: 600;
        }
        .btn-log:hover { background: var(--blue); color: white; border-color: var(--blue); }
        
        .log-viewer {
            background: var(--term-bg); color: var(--term-text);
            font-family: 'Courier New', Courier, monospace; font-size: 0.8rem;
            padding: 15px; max-height: 400px; overflow-y: auto;
            white-space: pre-wrap; line-height: 1.4; border-top: 1px solid var(--border);
        }
        .log-viewer.secondary { color: var(--term-filter); }
        
        .log-meta { font-size: 0.75rem; color: var(--muted); margin-left: 10px; font-weight: 400; }
        .footer-copy { margin-top: auto; padding-top: 40px; text-align: center; font-size: 0.75rem; color: var(--muted); opacity: 0.6; }
    </style>
</head>
<body>

    <div class="header">
        <h1>üè† Keenetic Dashboard</h1>
        <div class="header-controls">
            <select id="refresh_timer" class="refresh-select" onchange="updateRefresh(this.value)">
                <option value="0">Auto-Refresh: OFF</option>
                <option value="10000">10 Seconds</option>
                <option value="30000">30 Seconds</option>
                <option value="60000">1 Minute</option>
                <option value="300000">5 Minutes</option>
            </select>
            <span id="global_clock" class="clock-badge">Loading...</span>
        </div>
    </div>

    <div class="grid">
        <div class="card card-fw" onclick="location.href='firewall/index.html'">
            <div class="card-header"><h3>üõ°Ô∏è Keenetic Firewall</h3><span class="status-dot" id="fw_status"></span></div>
            <div class="stat-grid">
                <div class="stat-item"><span class="stat-label">IPv4 Entries</span><span class="stat-value txt-red" id="fw_v4">-</span></div>
                <div class="stat-item"><span class="stat-label">IPv6 Entries</span><span class="stat-value txt-purple" id="fw_v6">-</span></div>
                <div class="stat-item"><span class="stat-label">VPN Entries</span><span class="stat-value txt-orange" id="fw_vpn">-</span></div>
                <div class="stat-item"><span class="stat-label">Total Drops</span><span class="stat-value txt-blue" id="fw_drops">-</span></div>
            </div>
            <div class="sub-text" id="fw_update">Updated: -</div>
        </div>

        <div class="card card-tr" onclick="location.href='vnstat/ppp0-vnstat.html'">
            <div class="card-header"><h3>üìä Keenetic Traffic Analyzer</h3><span class="status-dot" id="tr_status"></span></div>
            <div class="stat-grid">
                <div class="stat-item" style="grid-column: 1 / -1;"><span class="stat-label">Interface</span><span class="stat-value" id="tr_iface">-</span></div>
                <div class="stat-item"><span class="stat-label">Today</span><span class="stat-value txt-green" id="tr_today">-</span></div>
                <div class="stat-item"><span class="stat-label">Month</span><span class="stat-value txt-blue" id="tr_month">-</span></div>
            </div>
            <div class="sub-text" id="tr_meta">Source: vnStat</div>
        </div>

        <div class="card card-ping" onclick="location.href='ping/index.html'">
            <div class="card-header"><h3>‚ö° Keenetic Ping Monitor</h3><span class="status-dot" id="ping_status"></span></div>
            <div class="stat-grid">
                <div class="stat-item"><span class="stat-label">Ping IPv4</span><span class="stat-value txt-green" id="ping_v4">-</span></div>
                <div class="stat-item"><span class="stat-label">Ping IPv6</span><span class="stat-value txt-purple" id="ping_v6">-</span></div>
                <div class="stat-item" style="grid-column: 1 / -1;"><span class="stat-label">Targets</span><span class="stat-value" style="font-size: 0.85rem; font-weight:500;" id="ping_target">-</span></div>
            </div>
            <div class="sub-text" id="ping_update">Updated: -</div>
        </div>
    </div>

    <div class="log-container">
        <details id="log_details_main" open>
            <summary onclick="fetchLog('main')">
                <div class="log-title">
                    <span>üìú System Log (Clean)</span>
                    <span id="log_size_main" class="log-meta"></span>
                </div>
                <div class="log-controls">
                    <button class="btn-log" onclick="downloadLog('main', event)">üíæ Save</button>
                    <button class="btn-log" onclick="fetchLog('main', true, event)">üîÑ Reload</button>
                    <span style="font-size: 1.2rem;">‚ñæ</span>
                </div>
            </summary>
            <div class="log-viewer" id="log_content_main">Click to load...</div>
        </details>
    </div>

    <div class="log-container">
        <details id="log_details_filtered">
            <summary onclick="fetchLog('filtered')">
                <div class="log-title">
                    <span style="color:var(--muted)">üóëÔ∏è Filtered Logs (Noise)</span>
                    <span id="log_size_filtered" class="log-meta"></span>
                </div>
                <div class="log-controls">
                    <button class="btn-log" onclick="downloadLog('filtered', event)">üíæ Save</button>
                    <button class="btn-log" onclick="fetchLog('filtered', true, event)">üîÑ Reload</button>
                    <span style="font-size: 1.2rem;">‚ñæ</span>
                </div>
            </summary>
            <div class="log-viewer secondary" id="log_content_filtered">Click to load...</div>
        </details>
    </div>
    <div class="footer-copy">Copyright &copy; 2026 mattheweli</div>

    <script src="firewall/firewall_data.js" onerror="console.log('FW missing')"></script>
    <script src="vnstat/vnstat_data.js" onerror="console.log('VnStat missing')"></script>
    <script src="ping/data.js" onerror="console.log('Ping missing')"></script>

    <script>
        const fmtBytes = (b) => { if (!b) return "0 B"; const u = ['B','KB','MB','GB','TB']; let i = 0; while(b >= 1024 && i < u.length-1){ b/=1024; i++; } return b.toFixed(2) + ' ' + u[i]; };
        const updateClock = () => { document.getElementById('global_clock').innerText = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit', second:'2-digit'}); };
        
        const logs = {
            main: { file: 'messages.log', loaded: false, idContent: 'log_content_main', idDetails: 'log_details_main', idSize: 'log_size_main' },
            filtered: { file: 'filtered.log', loaded: false, idContent: 'log_content_filtered', idDetails: 'log_details_filtered', idSize: 'log_size_filtered' }
        };

        async function fetchLog(type, force = false, event = null) {
            if (event) event.stopPropagation();
            const cfg = logs[type];
            if (!cfg) return;
            const details = document.getElementById(cfg.idDetails);
            if (!details) return; // Safety check if element removed
            if (!details.open && !force && !event) return;

            const viewer = document.getElementById(cfg.idContent);
            if (cfg.loaded && !force) return;

            viewer.innerText = "Loading " + cfg.file + " ...";
            try {
                const response = await fetch(cfg.file + '?t=' + new Date().getTime());
                if (!response.ok) throw new Error("Log file not found");
                const text = await response.text();
                viewer.innerText = text;
                document.getElementById(cfg.idSize).innerText = "(" + fmtBytes(text.length) + ")";
                viewer.scrollTop = viewer.scrollHeight;
                cfg.loaded = true;
            } catch (err) {
                viewer.innerText = "Error loading " + cfg.file + ":\n" + err.message + "\n\n(Ensure symlink exists in /opt/var/www/)";
            }
        }

        function downloadLog(type, event) {
            event.stopPropagation();
            const cfg = logs[type];
            if(!document.getElementById(cfg.idContent)) return;
            const content = document.getElementById(cfg.idContent).innerText;
            if (!content || content.startsWith("Loading") || content.startsWith("Error")) { alert("Load the log first."); return; }
            const blob = new Blob([content], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = "keenetic_" + type + "_" + new Date().toISOString().slice(0,10) + ".log";
            a.click();
            window.URL.revokeObjectURL(url);
        }

        let refreshInterval = null;
        function updateRefresh(val) {
            localStorage.setItem('dash_refresh_rate', val);
            if (refreshInterval) clearInterval(refreshInterval);
            if (val > 0) { refreshInterval = setInterval(() => { location.reload(true); }, parseInt(val)); }
        }

        setInterval(updateClock, 1000); updateClock();

        window.onload = function() {
            const savedRate = localStorage.getItem('dash_refresh_rate') || "0";
            document.getElementById('refresh_timer').value = savedRate;
            updateRefresh(savedRate);
            fetchLog('main');

            if (typeof window.FW_DATA !== 'undefined') {
                const d = window.FW_DATA;
                document.getElementById('fw_v4').innerText = d.lists.main || "0";
                document.getElementById('fw_v6').innerText = d.lists.main6 || "0";
                document.getElementById('fw_vpn').innerText = d.lists.vpn || "0";
                document.getElementById('fw_drops').innerText = d.lifetime || "0";
                document.getElementById('fw_update').innerText = "Last Update: " + d.updated;
                document.getElementById('fw_status').classList.add('online');
            } else { document.getElementById('fw_status').classList.add('offline'); }

            if (typeof window.TRAFFIC_RAW !== 'undefined') {
                try {
                    const iface = window.TRAFFIC_RAW.interfaces[0];
                    const tr = iface.traffic;
                    const dayData = tr.day[tr.day.length - 1] || {rx:0, tx:0};
                    const monthData = tr.month[tr.month.length - 1] || {rx:0, tx:0};
                    document.getElementById('tr_iface').innerText = iface.name || iface.id;
                    document.getElementById('tr_today').innerText = fmtBytes(dayData.rx + dayData.tx);
                    document.getElementById('tr_month').innerText = fmtBytes(monthData.rx + monthData.tx);
                    const u = iface.updated; const pad = (n) => n.toString().padStart(2, '0');
                    const ts = `${pad(u.date.day)}-${pad(u.date.month)}-${u.date.year} ${pad(u.time.hour)}:${pad(u.time.minute)}`;
                    document.getElementById('tr_meta').innerText = "Last Update: " + ts;
                    document.getElementById('tr_status').classList.add('online');
                } catch(e) { console.error("VnStat Logic Error", e); }
            } else { document.getElementById('tr_status').classList.add('offline'); }

            if (typeof window.PING_DATA !== 'undefined') {
                try {
                    const d = window.PING_DATA; const cur = d.current;
                    document.getElementById('ping_v4').innerText = cur.v4.ping + " ms";
                    document.getElementById('ping_v6').innerText = cur.v6.ping + " ms";
                    let tHtml = `<span style='opacity:0.6'>v4:</span> ${d.targets.v4}`;
                    if (d.config && d.config.ipv6) { tHtml += ` &nbsp; <span style='opacity:0.6'>v6:</span> ${d.targets.v6}`; } 
                    else if (d.targets.v6 && d.targets.v6.length > 5) { tHtml += ` &nbsp; <span style='opacity:0.6'>v6:</span> ${d.targets.v6}`; }
                    document.getElementById('ping_target').innerHTML = tHtml;
                    document.getElementById('ping_update').innerText = "Last Update: " + d.updated;
                    if(cur.v4.loss < 100) document.getElementById('ping_status').classList.add('online');
                    else document.getElementById('ping_status').classList.add('offline');
                } catch(e) { console.error("Ping Logic Error", e); }
            } else { document.getElementById('ping_status').classList.add('offline'); }
        };
    </script>
</body>
</html>
