#!/bin/sh

# ==============================================================================
# KEENTOOL MANAGER v0.4.10 (ALPHA)
# Author: MatthewEli
# Features:
#   - CORE: Smart Dependency Check (checks binary existence before opkg).
#   - UX: Allows continuing update process even if dependency install is skipped.
#   - UPDATE: Firewall Scan checks ALL suite files.
# ==============================================================================

export PATH=/opt/bin:/opt/sbin:/usr/bin:/usr/sbin:/bin:/sbin

# --- CONFIGURATION ---
REPO_USER="mattheweli"
BASE_URL="https://raw.githubusercontent.com/$REPO_USER"

# DIRECTORIES
BIN_DIR="/opt/bin"
PING_DIR="/opt/etc/pingtool"
NDM_DIR="/opt/etc/ndm/netfilter.d"
INIT_DIR="/opt/etc/init.d"
WEB_ROOT="/opt/var/www"

# --- DEPENDENCY LISTS ---
DEPS_CORE="lighttpd bash curl wget-ssl cron"
DEPS_VNSTAT="vnstat2 grep awk"
DEPS_PING="sqlite3-cli iputils-ping mtr grep awk"
# Added 'iprange' to DEPS_FW for IPv4 optimization
DEPS_FW="ipset iptables wget-ssl curl sqlite3-cli coreutils-date mtr grep awk sed iprange"
DEPS_SMB="bash tar samba4-client coreutils-date"

# --- TOOL DEFINITIONS ---
T_SELF="Keentool Manager|$BIN_DIR/keentool|KeenTool|keentool"
T_VNSTAT="Traffic Manager|$BIN_DIR/traffic_manager.sh|Traffic_manager|Script/traffic_manager.sh"
T_PING="Ping Monitor|$PING_DIR/pingtool_keenetic.sh|keenetic-pingtool|scripts/pingtool.sh"
T_SMB="SMB Backup|$BIN_DIR/smb_backup_tool.sh|SMB_Backup_tool|Script/smb_backup_tool.sh"
FW_CORE_LOCAL="$BIN_DIR/update_blocklist.sh"
FW_REPO="keenetic-firewall"

# --- CRON STRINGS ---
CRON_FILE="/opt/etc/crontab"
C_VNSTAT="*/10 * * * * root /opt/bin/traffic_manager.sh ppp0 >/opt/var/log/t_manager.log 2>&1"
C_PING="12,42 * * * * root /opt/etc/pingtool/pingtool_keenetic.sh >> /opt/var/log/connmon.log 2>&1"
C_FW_STAT="59 * * * * root /opt/bin/firewall_stats.sh > /dev/null 2>&1"
C_FW_UPD="0 4 * * * root /opt/bin/update_blocklist.sh > /dev/null 2>&1"
C_FW_VPN="12 */3 * * * root /opt/bin/vpn_scan.sh > /dev/null 2>&1"
C_SMB="00 03 */15 * * /opt/bin/smb_backup_tool.sh -run"

# COLORS
ESC=$(printf '\033')
RESET="${ESC}[0m"
BOLD="${ESC}[1m"
RED="${ESC}[31m"; GREEN="${ESC}[32m"; YELLOW="${ESC}[33m"; BLUE="${ESC}[34m"; CYAN="${ESC}[36m"; MAGENTA="${ESC}[35m"

# GLOBAL STATE
UPD_VNSTAT=""; UPD_PING=""; UPD_FW=""; UPD_SMB=""

# --- UTILS ---
header() { clear; echo -e "${BOLD}${BLUE}======================================================${RESET}"; echo -e "${BOLD}${BLUE}   KEENTOOL v0.4.10 ${RESET}${YELLOW}(Alpha)${BOLD}${BLUE}   |  Package Manager${RESET}"; echo -e "${BOLD}${BLUE}======================================================${RESET}"; echo ""; }
pause() { echo ""; read -p "Press [Enter] to return..." fack; }
get_version() { [ -f "$1" ] && VER=$(head -n 20 "$1" | grep -oE "v[0-9]+\.[0-9]+\.[0-9]+" | head -n 1); [ -z "$VER" ] && echo "0.0.0" || echo "${VER#v}"; }
get_md5() { [ -f "$1" ] && md5sum "$1" | awk '{print $1}' || echo "none"; }
ver_compare() { if [ "$1" = "$2" ]; then return 0; fi; awk -v v1="$1" -v v2="$2" 'BEGIN { split(v1,a,"."); split(v2,b,"."); for(i=1;i<=3;i++) { if(a[i]+0 > b[i]+0) exit 1; if(a[i]+0 < b[i]+0) exit 2; } exit 0; }'; return $?; }

# --- SELF UPDATE ---
action_self_update() {
    header; echo -e "${BOLD}Checking Keentool status...${RESET}"
    IFS='|' read -r N P R F <<EOF
$T_SELF
EOF
    TMP_FILE="/tmp/keentool.tmp"
    echo -n " -> Contacting GitHub ($R)... "; curl -s -L "$BASE_URL/$R/main/$F" -o "$TMP_FILE"
    if [ ! -s "$TMP_FILE" ]; then echo -e "${RED}Failed.${RESET}"; rm -f "$TMP_FILE"; pause; return; fi
    L_VER=$(get_version "$P"); R_VER=$(get_version "$TMP_FILE"); ver_compare "$R_VER" "$L_VER"; RES=$?
    echo -e " ${GREEN}OK${RESET}"; echo ""
    if [ $RES -eq 1 ]; then
        echo -e "${MAGENTA}Update: v$L_VER -> v$R_VER${RESET}"; echo -n " -> Apply & Restart? (y/n): "; read -r ans
        if [ "$ans" = "y" ] || [ "$ans" = "Y" ]; then mv "$TMP_FILE" "$P"; chmod +x "$P"; echo -e "${GREEN}Updated.${RESET}"; sleep 1; exec "$P"; else rm -f "$TMP_FILE"; pause; fi
    elif [ $RES -eq 2 ]; then
        echo -e "${YELLOW}Local is Newer (Dev).${RESET}"; rm -f "$TMP_FILE"; pause
    else
        if [ "$(get_md5 "$P")" != "$(get_md5 "$TMP_FILE")" ]; then
            echo -e "${CYAN}MD5 Differs.${RESET}"; echo -n " -> Force Reinstall? (y/n): "; read -r ans
            if [ "$ans" = "y" ] || [ "$ans" = "Y" ]; then mv "$TMP_FILE" "$P"; chmod +x "$P"; echo "Reinstalling..."; sleep 1; exec "$P"; else rm -f "$TMP_FILE"; pause; fi
        else echo -e "${GREEN}Up to date.${RESET}"; rm -f "$TMP_FILE"; pause; fi
    fi
}

# --- SYSTEM SETUP ---
setup_system() {
    header
    echo -e "${BOLD}System Pre-Flight Check${RESET}"; echo "---------------------------------------"
    echo -e "Checking Core Packages: ${DIM}$DEPS_CORE${RESET}"; check_and_install_deps "$DEPS_CORE"
    echo -e "Checking Web Environment..."
    check_webserver_config "force"
    echo -n "Checking Cron Service... "
    if pidof cron >/dev/null; then echo -e "${GREEN}Running${RESET}"; else
        echo -e "${RED}Stopped${RESET}"; echo -n " -> Start Cron? (y/n): "; read -r ans
        if [ "$ans" = "y" ] || [ "$ans" = "Y" ]; then /opt/etc/init.d/S10cron start; echo -e "    ${GREEN}Started.${RESET}"; fi
    fi
    echo ""; echo -e "${BOLD}System Ready.${RESET}"; pause
}

# --- GLOBAL SCAN ---
perform_global_scan() {
    echo -e "${BOLD}Checking for updates...${RESET}"
    check_tool_status() {
        local VNAME=$1; local LPATH=$2; local REPO=$3; local RFILE=$4
        echo -n "."
        if [ -f "$LPATH" ]; then
            local L_VER=$(get_version "$LPATH"); local TMP="/tmp/check_${RFILE##*/}.tmp"
            curl -s -L "$BASE_URL/$REPO/main/$RFILE" -o "$TMP"
            if [ -s "$TMP" ]; then
                local R_VER=$(get_version "$TMP"); ver_compare "$R_VER" "$L_VER"
                [ $? -eq 1 ] && eval "${VNAME}=' -> ${MAGENTA}v${R_VER}${RESET}'" || eval "${VNAME}=''"
                rm -f "$TMP"
            else eval "${VNAME}=''"; fi
        else eval "${VNAME}=''"; fi
    }
    
    # 1. Traffic Manager
    IFS='|' read -r N P R F <<EOF
$T_VNSTAT
EOF
    check_tool_status "UPD_VNSTAT" "$P" "$R" "$F"
    
    # 2. Ping Monitor
    IFS='|' read -r N P R F <<EOF
$T_PING
EOF
    check_tool_status "UPD_PING" "$P" "$R" "$F"
    
    # 3. Firewall Suite (Advanced Check)
    check_tool_status "UPD_FW" "$FW_CORE_LOCAL" "$FW_REPO" "scripts/update_blocklist.sh"
    
    # If Core is up to date, check all components
    if [ -z "$UPD_FW" ] && [ -f "$FW_CORE_LOCAL" ]; then
        FW_SUBS="$BIN_DIR/firewall_manager.sh|scripts/firewall_manager.sh
$BIN_DIR/firewall_monitor|scripts/firewall_monitor
$BIN_DIR/firewall_stats.sh|scripts/firewall_stats.sh
$BIN_DIR/vpn_scan.sh|scripts/vpn_scan.sh
$NDM_DIR/100-firewall.sh|scripts/100-firewall.sh
$INIT_DIR/S00ipset-load|scripts/S00ipset-load"
        
        IFS=$'\n'
        for ROW in $FW_SUBS; do
            local SUB_L=$(echo "$ROW" | cut -d'|' -f1)
            local SUB_R=$(echo "$ROW" | cut -d'|' -f2)
            if [ -f "$SUB_L" ]; then
                echo -n "."
                local SL_VER=$(get_version "$SUB_L")
                local STMP="/tmp/chk_fw_sub.tmp"
                curl -s -L "$BASE_URL/$FW_REPO/main/$SUB_R" -o "$STMP"
                if [ -s "$STMP" ]; then
                    local SR_VER=$(get_version "$STMP")
                    ver_compare "$SR_VER" "$SL_VER"
                    if [ $? -eq 1 ]; then
                        UPD_FW=" -> ${MAGENTA}Patch${RESET}"
                        rm -f "$STMP"
                        break
                    fi
                fi
                rm -f "$STMP"
            fi
        done
        unset IFS
    fi
    
    # 4. SMB Backup
    IFS='|' read -r N P R F <<EOF
$T_SMB
EOF
    check_tool_status "UPD_SMB" "$P" "$R" "$F"
    echo " Done."; sleep 0.5
}

# --- DEPENDENCY & INSTALL ---
check_and_install_deps() {
    PKG_LIST="$1"; MISSING=""
    for PKG in $PKG_LIST; do 
        # 1. Check if package is installed via opkg
        if opkg list-installed | grep -q "^$PKG"; then continue; fi
        
        # 2. Check if binary exists (for built-in tools like awk, sed, grep)
        if command -v "$PKG" >/dev/null 2>&1; then continue; fi
        
        # 3. If neither, it's missing
        MISSING="$MISSING $PKG"
    done
    
    if [ -n "$MISSING" ]; then
        echo -e " -> ${YELLOW}Missing:${RESET} $MISSING"; echo -n " -> Install? (y/n): "; read -r ans
        if [ "$ans" = "y" ] || [ "$ans" = "Y" ]; then
            echo "    Installing..."; opkg update >/dev/null 2>&1; opkg install $MISSING
            if echo "$PKG_LIST" | grep -q "lighttpd"; then check_webserver_config "check"; fi
            if echo "$PKG_LIST" | grep -q "vnstat2"; then check_vnstat_config; fi
        else 
            return 1 # Failed/Skipped
        fi
    else echo -e " -> ${GREEN}OK${RESET}"; fi
    
    if echo "$PKG_LIST" | grep -q "lighttpd"; then check_webserver_config "check"; fi
    if echo "$PKG_LIST" | grep -q "vnstat2"; then check_vnstat_config; fi
    return 0
}

check_vnstat_config() {
    CONF="/opt/etc/vnstat.conf"
    if [ ! -f "$CONF" ]; then
        echo -n " -> ${YELLOW}Configure vnStat (Recommended)? (y/n): ${RESET}"; read -r ans
        if [ "$ans" = "y" ] || [ "$ans" = "Y" ]; then
            cat > "$CONF" <<EOF
# vnStat 2.13 configuration file
#
# lines starting with # or ; are comments, everything has default
# values, remove ; before each option to change its value

# default interface (leave empty for automatic selection)
;Interface ""

# location of the database directory
;DatabaseDir "/opt/var/lib/vnstat"

# locale (LC_ALL) ("-" = use system locale)
;Locale "-"

# date output formats for -d, -m, -t and -w
;DayFormat    "%Y-%m-%d"
;MonthFormat  "%Y-%m"
;TopFormat    "%Y-%m-%d"

# characters used for visuals
;RXCharacter       "%"
;TXCharacter       ":"
;RXHourCharacter   "r"
;TXHourCharacter   "t"

# how units are prefixed when traffic is shown
# 0 = IEC standard prefixes (KiB/MiB/GiB...)
# 1 = old style binary prefixes (KB/MB/GB...)
# 2 = SI decimal prefixes (kB/MB/GB...)
;UnitMode 0

# used rate unit (0 = bytes, 1 = bits)
;RateUnit 1

# how units are prefixed when traffic rate is shown in bits
# 0 = IEC binary prefixes (Kibit/s...)
# 1 = SI decimal prefixes (kbit/s...)
;RateUnitMode 1

# output style
# 0 = minimal & narrow, 1 = bar column visible
# 2 = same as 1 except rate in summary
# 3 = rate column visible
;OutputStyle 3
;EstimateBarVisible 1

# number of decimals to use in outputs
;DefaultDecimals 2
;HourlyDecimals 1

# spacer for separating hourly sections (0 = none, 1 = '|', 2 = '][', 3 = '[ ]')
;HourlySectionStyle 2

# how many seconds should sampling for -tr take by default
;Sampletime 5

# show animation at the beginning of -l / --live line (1 = enabled, 0 = disabled)
;LiveSpinner 1

# default query mode
# 0 = summary, 1 = days, 2 = months, 3 = top, 4 = single summary, 5 = short
# 7 = hours graph, 8 = xml, 9 = one line, 10 = json, 11 = hours, 12 = 5 minute
;QueryMode 0

# default list output entry limits (0 = all)
;List5Mins       24
;ListHours       24
;ListDays        30
;ListMonths      12
;ListYears       0
;ListTop         10

# how to match interface given for query to interface in database
# 0 = case sensitive exact match to interface name
# 1 = method 0 followed by case sensitive exact match of alias
# 2 = method 1 followed by case insensitive exact match of alias
# 3 = method 2 followed by case insensitive beginning match of alias
;InterfaceMatchMethod 3

# visibility of estimate line and text used in it
;EstimateVisible 1
;EstimateText "estimated"

# interface order (0 = alphabetical by name, 1 = alphabetical by alias)
;InterfaceOrder 0

# vnstatd
##

# switch to given user when started as root (leave empty to disable)
;DaemonUser ""

# switch to given group when started as root (leave empty to disable)
;DaemonGroup ""

# try to detect interface maximum bandwidth, 0 = disable feature
# MaxBandwidth will be used as fallback value when enabled
;BandwidthDetection 1

# maximum bandwidth (Mbit) for all interfaces, 0 = disable feature
# (unless interface specific limit is given)
;MaxBandwidth 1000

# interface specific limits
#  example 8Mbit limit for eth0 (remove # to activate):
#MaxBWeth0 8

# data retention durations (-1 = unlimited, 0 = feature disabled)
;5MinuteHours   48
;HourlyDays       4
;DailyDays       62
;MonthlyMonths  25
;YearlyYears     -1
;TopDayEntries  20

# how often (in seconds) interface data is updated
;UpdateInterval 60

# how often (in seconds) interface status changes are checked
;PollInterval 30

# how often (in minutes) data is saved to database
;SaveInterval 5

# how often (in minutes) data is saved when all interface are offline
;OfflineSaveInterval 30

# rescan database after save for new interfaces to be monitored (1 = enabled, 0 = disabled)
;RescanDatabaseOnSave 1

# automatically start monitoring all interfaces not found in the database
# (1 = enabled, 0 = disabled)
;AlwaysAddNewInterfaces 0

# on which day should months change
;MonthRotate 1
;MonthRotateAffectsYears 0

# filesystem disk space check (1 = enabled, 0 = disabled)
;CheckDiskSpace 1

# how much the boot time can variate between updates (seconds)
;BootVariation 15

# create database entries even when there is no traffic (1 = enabled, 0 = disabled)
;TrafficlessEntries 1

# how many minutes to wait during daemon startup for system clock to
# sync time if most recent database update appears to be in the future
;TimeSyncWait 5

# how often (in minutes) bandwidth detection is done when
# BandwidthDetection is enabled (0 = disabled)
;BandwidthDetectionInterval 5

# force data save when interface status changes (1 = enabled, 0 = disabled)
;SaveOnStatusChange 1

# enable / disable logging (0 = disabled, 1 = logfile, 2 = syslog)
;UseLogging 2

# create dirs if needed (1 = enabled, 0 = disabled)
;CreateDirs 1

# update ownership of files if needed (1 = enabled, 0 = disabled)
;UpdateFileOwner 1

# file used for logging if UseLogging is set to 1
;LogFile "/opt/var/log/vnstat/vnstat.log"

# file used as daemon pid / lock file
;PidFile "/opt/var/run/vnstat/vnstat.pid"

# 1 = 64-bit, 0 = 32-bit, -1 = old style logic, -2 = automatic detection
;64bitInterfaceCounters -2

# use SQLite Write-Ahead Logging mode (1 = enabled, 0 = disabled)
;DatabaseWriteAheadLogging 0

# change the setting of the SQLite "synchronous" flag
# (-1 = auto, 0 = off, 1, = normal, 2 = full, 3 = extra)
;DatabaseSynchronous -1

# database uses UTC instead of local timezone (1 = enabled, 0 = disabled)
;UseUTC 0

# database maintenance (1 = enabled, 0 = disabled)
;VacuumOnStartup 1
;VacuumOnHUPSignal 1

# vnstati
##

# title timestamp format
;HeaderFormat "%Y-%m-%d %H:%M"

# show hours with rate (1 = enabled, 0 = disabled)
;HourlyRate 1

# show rate in summary (1 = enabled, 0 = disabled)
;SummaryRate 1

# transparent background (1 = enabled, 0 = disabled)
;TransparentBg 0

# image size control
;LargeFonts 0
;LineSpacingAdjustment 0
;ImageScale 100

# 5 minutes graph size control
;5MinuteGraphResultCount 576
;5MinuteGraphHeight 300

# hourly graph mode (0 = 24 hour sliding window, 1 = begins from midnight)
;HourlyGraphMode 0

# horizontal/vertical summary graph (0 = hours, 1 = 5 minutes)
;SummaryGraph 0

# traffic estimate bar style
# (0 = not shown, 1 = continuation of existing bar, 2 = separate bar)
;EstimateStyle 1

# bar column in list outputs shows rate if OutputStyle is 3
# (1 = enabled, 0 = disabled)
;BarColumnShowsRate 0

# image colors
;CBackground      "FFFFFF"
;CEdge            "AEAEAE"
;CHeader          "606060"
;CHeaderTitle     "FFFFFF"
;CHeaderDate      "FFFFFF"
;CText            "000000"
;CLine            "B0B0B0"
;CLineL           "-"
;CPercentileLine "CF0045"
;CRx              "92CF00"
;CTx              "606060"
;CRxD             "-"
;CTxD             "-"
;CTotal           "0098CF"
EOF
            # Try S32vnstat2 first
            if [ -x /opt/etc/init.d/S32vnstat2 ]; then
                /opt/etc/init.d/S32vnstat2 restart >/dev/null 2>&1
                echo -e "    ${GREEN}vnStat Configured & Restarted (S32vnstat2).${RESET}"
            elif [ -x /opt/etc/init.d/S26vnstatd ]; then
                /opt/etc/init.d/S26vnstatd restart >/dev/null 2>&1
                echo -e "    ${GREEN}vnStat Configured & Restarted (S26vnstatd).${RESET}"
            else
                echo -e "    ${YELLOW}vnStat Configured but init script not found.${RESET}"
            fi
        fi
    fi
}

check_webserver_config() {
    MODE=$1
    CONF="/opt/etc/lighttpd/lighttpd.conf"
    
    if [ ! -d "$WEB_ROOT" ]; then mkdir -p "$WEB_ROOT"; fi

    if [ ! -f "$WEB_ROOT/index.html" ] || [ "$MODE" = "force" ]; then
         echo -n " -> Downloading Dashboard to $WEB_ROOT... "
         curl -s -L "$BASE_URL/KeenTool/main/index.html" -o "$WEB_ROOT/index.html"
         if [ -s "$WEB_ROOT/index.html" ]; then
            echo -e "${GREEN}OK${RESET}"; chmod 644 "$WEB_ROOT/index.html"
         else
            echo -e "${RED}Failed download! Creating Stub.${RESET}"
            echo "<h1>Keenetic Dashboard</h1><p>Apps installed via Keentool.</p>" > "$WEB_ROOT/index.html"
            chmod 644 "$WEB_ROOT/index.html"
         fi
    fi

    if [ -f "$CONF" ]; then
        if grep -q "server.port.*=.*81" "$CONF" && [ "$MODE" != "force" ]; then return 0; fi
    fi
    
    if [ "$MODE" != "force" ]; then
        echo -n " -> ${YELLOW}Configure Lighttpd (Port 81)? (y/n): ${RESET}"; read -r ans
        [ "$ans" != "y" ] && [ "$ans" != "Y" ] && return 0
    fi

    mkdir -p /opt/etc/lighttpd
    
    cat > "$CONF" <<EOF
### Documentation
# https://wiki.lighttpd.net/
#
### Configuration Syntax
# https://wiki.lighttpd.net/Docs_Configuration
#
### Configuration Options
# https://wiki.lighttpd.net/Docs_ConfigurationOptions
#
### Configuration Variables (potentially used in /opt/etc/lighttpd/conf.d/*.conf)
var.log_root    = "/opt/var/log/lighttpd/"
var.server_root = "/opt/var/www/"
var.state_dir   = "/opt/var/run/"
var.home_dir    = "/opt/var/lib/lighttpd/"
var.conf_dir    = "/opt/etc/lighttpd"
var.vhosts_dir  = server_root + "/vhosts"
var.cache_dir   = "/opt/var/cache/lighttpd"
var.socket_dir  = home_dir + "/sockets"

### OpenWRT lighttpd base configuration
server.document-root        = server_root
server.upload-dirs          = ( "/opt/tmp" )
server.errorlog             = log_root + "error.log"
server.pid-file             = state_dir + "lighttpd.pid"
#server.username             = "http"
#server.groupname            = "www-data"
server.port = 81

# historical; preserved for compatibility; should have been disabled by default
index-file.names            = ( "index.php", "index.html",
                                "index.htm", "default.htm",
                                "index.html.htm" )

static-file.exclude-extensions = ( ".php", ".pl", ".fcgi" )

include "/opt/etc/lighttpd/mime.conf"
include "/opt/etc/lighttpd/conf.d/*.conf"

### Customizations
# customizations should generally be placed in separate files such as
#   /opt/etc/lighttpd/conf.d/00_vars.conf    # override variables for conf.d/*.conf
#   /opt/etc/lighttpd/conf.d/zz_custom.conf  # override other conf.d/*.conf settings
EOF
    
    [ -x /opt/etc/init.d/S80lighttpd ] && { /opt/etc/init.d/S80lighttpd restart >/dev/null 2>&1; echo -e "    ${GREEN}Configured & Restarted.${RESET}"; }
}

install_file() {
    REPO=$1; RFILE=$2; LPATH=$3; DIR=$(dirname "$LPATH"); mkdir -p "$DIR"
    echo -n " -> Downloading ${CYAN}${RFILE##*/}${RESET}... "; curl -s -L "$BASE_URL/$REPO/main/$RFILE" -o "$LPATH"
    if [ -s "$LPATH" ]; then chmod +x "$LPATH"; echo -e "${GREEN}OK${RESET}"; return 0; else echo -e "${RED}Failed${RESET}"; rm -f "$LPATH"; return 1; fi
}

smart_process() {
    NAME=$1; LPATH=$2; REPO=$3; RFILE=$4
    if [ ! -f "$LPATH" ]; then
        echo -e "${BOLD}Installing: $NAME${RESET}"; echo -n " -> Confirm? (y/n): "; read -r ans
        [ "$ans" = "y" ] || [ "$ans" = "Y" ] && install_file "$REPO" "$RFILE" "$LPATH"
        return
    fi
    echo -n "Checking $NAME... "; TMP_FILE="/tmp/${RFILE##*/}.tmp"; curl -s -L "$BASE_URL/$REPO/main/$RFILE" -o "$TMP_FILE"
    if [ ! -s "$TMP_FILE" ]; then echo -e "${RED}Net Error${RESET}"; rm -f "$TMP_FILE"; return; fi
    L_VER=$(get_version "$LPATH"); R_VER=$(get_version "$TMP_FILE"); ver_compare "$R_VER" "$L_VER"; RES=$?
    if [ $RES -eq 1 ]; then
        echo -e "${MAGENTA}Update: v$L_VER -> v$R_VER${RESET}"; echo -n "    Apply? (y/n): "; read -r ans
        [ "$ans" = "y" ] && { mv "$TMP_FILE" "$LPATH"; chmod +x "$LPATH"; echo -e "    ${GREEN}Updated.${RESET}"; } || rm -f "$TMP_FILE"
    elif [ $RES -eq 2 ]; then echo -e "${YELLOW}Local Newer.${RESET}"; rm -f "$TMP_FILE"
    else
        if [ "$(get_md5 "$LPATH")" != "$(get_md5 "$TMP_FILE")" ]; then
            echo -e "${CYAN}MD5 Differs.${RESET}"; echo -n "    Overwrite local? (y/n): "; read -r ans
            [ "$ans" = "y" ] && { mv "$TMP_FILE" "$LPATH"; chmod +x "$LPATH"; echo -e "    ${GREEN}Replaced.${RESET}"; } || rm -f "$TMP_FILE"
        else echo -e "${GREEN}Up to date.${RESET}"; rm -f "$TMP_FILE"; fi
    fi
}

# --- CRON ---
cron_exists() { grep -Fq "$1" "$CRON_FILE"; }
add_cron() { if ! cron_exists "$1"; then echo "$1" >> "$CRON_FILE"; echo -e "    ${GREEN}Added.${RESET}"; else echo -e "    ${YELLOW}Exists.${RESET}"; fi; }
remove_cron() { if cron_exists "$1"; then grep -Fv "$1" "$CRON_FILE" > "$CRON_FILE.tmp" && mv "$CRON_FILE.tmp" "$CRON_FILE"; echo -e "    ${RED}Removed.${RESET}"; fi; }
manage_cron_menu() {
    echo -e "${BOLD}Cron Jobs:${RESET}"; MISSING=0
    for L in "$@"; do if cron_exists "$L"; then echo -e "  [${GREEN}ON${RESET}] ${DIM}${L:0:50}...${RESET}"; else echo -e "  [${RED}OFF${RESET}] ${DIM}${L:0:50}...${RESET}"; MISSING=1; fi; done
    echo ""
    if [ $MISSING -eq 1 ]; then echo -n " -> Enable missing? (y/n): "; read -r ans; [ "$ans" = "y" ] && for L in "$@"; do add_cron "$L"; done
    else echo -n " -> Disable jobs? (y/n): "; read -r ans; [ "$ans" = "y" ] && for L in "$@"; do remove_cron "$L"; done; fi
}

# --- ACTIONS ---
action_generic() {
    header; IFS='|' read -r N P R F <<EOF
$1
EOF
    [ "$N" = "SMB Backup" ] && check_and_install_deps "$DEPS_SMB" 
    [ "$N" = "Traffic Manager" ] && check_and_install_deps "$DEPS_VNSTAT"
    [ "$N" = "Ping Monitor" ] && check_and_install_deps "$DEPS_PING"
    smart_process "$N" "$P" "$R" "$F"; shift; [ -n "$1" ] && manage_cron_menu "$@"; pause;
}

action_firewall() {
    while true; do
        header; if [ -f "$FW_CORE_LOCAL" ]; then V_CORE=$(get_version "$FW_CORE_LOCAL"); S_MAIN="${GREEN}Installed (v$V_CORE)${RESET}"; else S_MAIN="${DIM}Missing${RESET}"; fi
        echo -e "Firewall Suite Status: $S_MAIN"; echo ""; echo " 1. Install / Update"; echo " 2. Manage Cron"; echo " 3. Run Manager"; echo " 4. Run Monitor"; echo ""; echo " 0. Back"; echo ""; echo -n "Select: "; read -r op
        case $op in
            1) header;
               # Smart check logic:
               check_and_install_deps "$DEPS_FW"
               RES_DEPS=$?
               if [ $RES_DEPS -ne 0 ]; then
                   echo -n " -> Dependencies missing. Continue anyway? (y/n): "
                   read -r ans
                   if [ "$ans" != "y" ] && [ "$ans" != "Y" ]; then pause; break; fi
               fi
               
               REPO="$FW_REPO"
               # Added 'scripts/' prefix to all firewall files
               smart_process "Manager" "$BIN_DIR/firewall_manager.sh" $REPO "scripts/firewall_manager.sh"
               smart_process "Monitor" "$BIN_DIR/firewall_monitor" $REPO "scripts/firewall_monitor"
               smart_process "Stats" "$BIN_DIR/firewall_stats.sh" $REPO "scripts/firewall_stats.sh"
               smart_process "Updater" "$BIN_DIR/update_blocklist.sh" $REPO "scripts/update_blocklist.sh"
               smart_process "VPN Scan" "$BIN_DIR/vpn_scan.sh" $REPO "scripts/vpn_scan.sh"
               smart_process "Netfilter" "$NDM_DIR/100-firewall.sh" $REPO "scripts/100-firewall.sh"
               smart_process "Init" "$INIT_DIR/S00ipset-load" $REPO "scripts/S00ipset-load"
               pause ;;
            2) header; manage_cron_menu "$C_FW_STAT" "$C_FW_UPD" "$C_FW_VPN"; pause ;;
            3) [ -f "$BIN_DIR/firewall_manager.sh" ] && $BIN_DIR/firewall_manager.sh || { echo "Missing"; sleep 1; };;
            4) [ -f "$BIN_DIR/firewall_monitor" ] && $BIN_DIR/firewall_monitor || { echo "Missing"; sleep 1; };;
            0) return ;;
        esac
    done
}

# --- MAIN MENU ---
while true; do
    IFS='|' read -r N P R F <<EOF
$T_VNSTAT
EOF
    if [ -f "$P" ]; then V=$(get_version "$P"); L1="${GREEN}v$V${RESET}"; else L1="${DIM}Missing${RESET}"; fi
    IFS='|' read -r N P R F <<EOF
$T_PING
EOF
    if [ -f "$P" ]; then V=$(get_version "$P"); L2="${GREEN}v$V${RESET}"; else L2="${DIM}Missing${RESET}"; fi
    if [ -f "$FW_CORE_LOCAL" ]; then V=$(get_version "$FW_CORE_LOCAL"); L3="${GREEN}v$V${RESET}"; else L3="${DIM}Missing${RESET}"; fi
    IFS='|' read -r N P R F <<EOF
$T_SMB
EOF
    if [ -f "$P" ]; then V=$(get_version "$P"); [ "$V" = "0.0.0" ] && L4="${GREEN}Installed${RESET}" || L4="${GREEN}v$V${RESET}"; else L4="${DIM}Missing${RESET}"; fi

    header
    echo -e " ${BOLD}System:${RESET}"; echo -e " 0. ${CYAN}System Setup${RESET} (Deps & WebServer)"
    echo ""; echo -e " ${BOLD}Tools:${RESET}"
    echo -e " 1. Traffic Manager      [$L1]$UPD_VNSTAT"
    echo -e " 2. Ping Monitor         [$L2]$UPD_PING"
    echo -e " 3. Firewall Suite       [$L3]$UPD_FW"
    echo -e " 4. SMB Backup Tool      [$L4]$UPD_SMB"
    echo ""; echo -e " ${BOLD}Global:${RESET}"
    echo -e " u. Check for Updates (Tools)"
    echo -e " s. ${MAGENTA}Update Keentool (Self)${RESET}"
    echo -e " c. View Crontab"; echo -e " q. Quit"
    echo ""; echo -n "Select: "; read choice
    case $choice in
        0) setup_system ;;
        1) action_generic "$T_VNSTAT" "$C_VNSTAT" "$C_VNSTAT_GEN" ;;
        2) action_generic "$T_PING" "$C_PING" ;;
        3) action_firewall ;;
        4) action_generic "$T_SMB" "$C_SMB" ;;
        u) perform_global_scan ;;
        s) action_self_update ;;
        c) header; cat $CRON_FILE; pause ;;
        q) exit 0 ;;
    esac
done
